CREATE OR ALTER PROCEDURE dbo.usp_Purge_Telemetry_OlderThan_MaxTSMinusYears
    @Years int = 4
AS
BEGIN
    SET NOCOUNT ON;
    SET DEADLOCK_PRIORITY LOW;

    DECLARE @maxTs datetime2(3) = (SELECT MAX(TS) FROM dbo.Telemetry);
    IF @maxTs IS NULL RETURN;  -- データ無しなら何もしない

    DECLARE @cutoff datetime2(3) = DATEADD(year, -@Years, @maxTs);

    DELETE FROM dbo.Telemetry
    WHERE TS < @cutoff;
END
GO
